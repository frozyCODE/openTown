<!DOCTYPE html>
<html lang="fr">
  <!DOCTYPE html>
  <html lang="fr">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>La Voyante - N.I.R.D.</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link
        href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap"
        rel="stylesheet"
      />
      <style>
        body {
          opacity: 0;
          transition: opacity 0.3s ease-in-out;
        }
        .mystical-font {
          font-family: "MedievalSharp", cursive;
        }
        .mystical-box {
          background: rgba(20, 10, 30, 0.85);
          border: 2px solid #9d4edd;
          box-shadow: 0 0 20px #9d4edd, inset 0 0 50px rgba(0, 0, 0, 0.8);
        }
        .mystical-input {
          background: rgba(0, 0, 0, 0.6);
          border: 1px solid #c77dff;
          color: #e0aaff;
        }
        .mystical-btn {
          background: linear-gradient(45deg, #5a189a, #9d4edd);
          border: 1px solid #c77dff;
          color: #fff;
          text-shadow: 0 0 5px #e0aaff;
        }
        .mystical-btn:hover {
          box-shadow: 0 0 15px #9d4edd;
        }
        .scrollbar-mystical::-webkit-scrollbar {
          width: 8px;
        }
        .scrollbar-mystical::-webkit-scrollbar-track {
          background: #240046;
        }
        .scrollbar-mystical::-webkit-scrollbar-thumb {
          background: #9d4edd;
          border-radius: 4px;
        }
      </style>
    </head>
    <body
      class="w-screen h-screen bg-cover bg-center overflow-hidden"
      style="background-image: url('/images/Interieur_Voyante.jpg')"
      onload="document.body.style.opacity='1'"
    >
      <%- include('partials/menu') %>
      <div class="w-full h-full flex items-center justify-center bg-black/60">
        <div
          class="max-w-[800px] w-full mx-4 p-8 mystical-box rounded-xl text-center backdrop-blur-sm mystical-font"
        >
          <h1
            class="text-5xl font-bold mb-2 text-[#e0aaff] drop-shadow-[0_0_10px_rgba(224,170,255,0.8)]"
          >
            Philoute
          </h1>
          <h2 class="text-2xl italic text-[#c77dff] mb-6">
            Le Chat-rlatan du NumÃ©rique
          </h2>

          <div
            id="chat-history"
            class="h-[350px] overflow-y-auto bg-black/40 rounded-lg p-4 mb-6 text-left border border-[#5a189a] scrollbar-mystical"
          >
            <div
              class="mb-4 p-3 rounded bg-[#240046]/50 border-l-4 border-[#9d4edd]"
            >
              <span class="font-bold text-[#e0aaff] text-lg">Philoute:</span>
              <p class="text-[#e0aaff] mt-1">
                Approche, Ã¢me Ã©garÃ©e... Pose ta question Ã  l'oracle, mais gare Ã 
                la rÃ©ponse !
              </p>
            </div>
          </div>

          <form id="chat-form" class="flex gap-3">
            <input
              type="text"
              id="user-input"
              class="flex-1 p-4 rounded-lg mystical-input text-lg focus:outline-none focus:border-[#e0aaff] placeholder-[#7b2cbf]"
              placeholder="Interrogez les esprits..."
              required
              autocomplete="off"
            />
            <button
              type="submit"
              class="px-8 py-3 mystical-btn font-bold rounded-lg text-xl transition-all transform hover:scale-105 flex items-center gap-3 justify-center"
            >
              <span>Invoquer</span>
              <span class="text-2xl animate-pulse">ðŸ”®</span>
            </button>
          </form>

          <a
            href="/"
            class="inline-block mt-8 px-6 py-3 bg-gradient-to-r from-red-900 to-red-700 text-red-100 font-bold rounded-lg border border-red-500 hover:from-red-800 hover:to-red-600 hover:text-white hover:shadow-[0_0_15px_rgba(220,38,38,0.6)] transition-all transform hover:-translate-y-1"
            >S'enfuir de cet endroit maudit</a
          >
        </div>
      </div>

      <script>
        const chatForm = document.getElementById("chat-form");
        const chatHistory = document.getElementById("chat-history");
        const userInput = document.getElementById("user-input");

        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = userInput.value;
          if (!message) return;

          // User message
          appendMessage(
            "Vous",
            message,
            "text-[#ff9e00]",
            "bg-[#3c096c]/50 border-[#ff9e00]"
          );
          userInput.value = "";

          // Loading state
          const loadingId = appendMessage(
            "Philoute",
            "Les esprits murmurent...",
            "text-[#e0aaff] animate-pulse",
            "bg-[#240046]/50 border-[#9d4edd]"
          );

          try {
            const response = await fetch("/api/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });
            const data = await response.json();

            // Remove loading and show response
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();
            appendMessage(
              "Philoute",
              data.reply,
              "text-[#e0aaff]",
              "bg-[#240046]/50 border-[#9d4edd]"
            );
          } catch (error) {
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();
            appendMessage(
              "Philoute",
              "Le lien cosmique est rompu...",
              "text-red-400",
              "bg-red-900/20 border-red-500"
            );
          }
        });

        function appendMessage(sender, text, textColorClass, bgClass) {
          const div = document.createElement("div");
          div.className = `mb-4 p-3 rounded border-l-4 ${bgClass}`;
          const id = "msg-" + Date.now();
          div.id = id;

          const senderSpan = document.createElement("span");
          senderSpan.className = `font-bold ${textColorClass} text-lg`;
          senderSpan.textContent = sender + ":";

          const messageP = document.createElement("p");
          messageP.className = `${textColorClass} mt-1`;
          messageP.textContent = text; // Utilisation de textContent pour Ã©viter les failles XSS

          div.appendChild(senderSpan);
          div.appendChild(messageP);

          chatHistory.appendChild(div);
          chatHistory.scrollTop = chatHistory.scrollHeight;
          return id;
        }
      </script>
      <script src="/js/app.js"></script>
    </body>
  </html>
</html>
